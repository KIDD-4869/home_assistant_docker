# Home Assistant 完整安装指南 - 从零开始

> 适用于 macOS (Apple Silicon) 用户  
> 从 UTM 安装到 HACS 集成的完整教程

---

## 📖 目录

1. [准备工作](#准备工作)
2. [安装 UTM 虚拟机软件](#第一步安装-utm-虚拟机软件)
3. [下载 Home Assistant OS 镜像](#第二步下载-home-assistant-os-镜像)
4. [创建并配置虚拟机](#第三步创建并配置虚拟机)
5. [首次启动和初始设置](#第四步首次启动和初始设置)
6. [扩展磁盘空间（可选但推荐）](#第五步扩展磁盘空间可选但推荐)
7. [安装 HACS 社区商店](#第六步安装-hacs-社区商店)
8. [集成米家设备（可选）](#第七步集成米家设备可选)
9. [常见问题解决](#常见问题解决)

---

## 准备工作

### 系统要求

- **硬件**：Apple Silicon Mac (M系列)
- **系统**：macOS 12.0 或更高版本
- **内存**：建议至少 8GB RAM（分配 4GB 给虚拟机）
- **存储**：至少 20GB 可用空间（推荐 64GB）
- **网络**：稳定的互联网连接

### 预计时间

- 总时间：约 30-60 分钟
- UTM 安装：5 分钟
- 虚拟机创建：10 分钟
- 系统初始化：10-15 分钟
- HACS 安装：10 分钟
- 设备集成：10-20 分钟

---

## 第一步：安装 UTM 虚拟机软件

UTM 是 macOS 上的免费虚拟机软件，对 Apple Silicon 优化良好。

### 方法 1：通过 Homebrew 安装（推荐）

如果你已安装 Homebrew：

```bash
brew install --cask utm
```

### 方法 2：从官网下载

1. 访问 https://mac.getutm.app/
2. 点击 "Download" 下载最新版本
3. 打开下载的 `.dmg` 文件
4. 将 UTM 拖到 Applications 文件夹
5. 打开 UTM（首次打开可能需要在系统设置中允许）

### 验证安装

打开 UTM，看到主界面即表示安装成功。

---

## 第二步：下载 Home Assistant OS 镜像

### 2.1 创建下载目录

```bash
mkdir -p ~/Downloads/homeassistant
cd ~/Downloads/homeassistant
```

### 2.2 下载镜像文件

访问 https://github.com/home-assistant/operating-system/releases/latest

找到文件名类似 `haos_ova-XX.X.aarch64.qcow2.xz` 的文件（XX.X 是版本号）

**使用命令下载（推荐）：**

```bash
# 下载最新版本（请替换版本号为最新版）
curl -LO https://github.com/home-assistant/operating-system/releases/download/13.2/haos_ova-13.2.aarch64.qcow2.xz
```

### 2.3 解压镜像

```bash
# 解压文件
xz -d haos_ova-13.2.aarch64.qcow2.xz

# 验证文件
ls -lh haos_ova-*.qcow2
```

解压后应该看到一个 `.qcow2` 文件，大小约 1-2GB。

---

## 第三步：创建并配置虚拟机

### 3.1 创建新虚拟机

1. 打开 UTM
2. 点击左上角的 **"+"** 按钮
3. 选择 **"虚拟化"** (Virtualize)
4. 选择 **"Linux"**
5. 点击 **"继续"**

### 3.2 配置启动方式

1. **取消勾选** "使用 Apple 虚拟化"
2. **取消勾选** "从 ISO 启动"
3. 点击 **"继续"**

### 3.3 配置硬件资源

**推荐配置：**
- **内存**：4096 MB (4 GB)
- **CPU 核心**：2 核心

**最低配置：**
- **内存**：2048 MB (2 GB)
- **CPU 核心**：2 核心

> 💡 提示：如果你的 Mac 内存充足（16GB+），建议使用推荐配置

点击 **"继续"**

### 3.4 配置存储

1. 将存储大小改为 **64 GB**（重要！）
2. 点击 **"继续"**

> ⚠️ 注意：虚拟磁盘是动态分配的，不会立即占用 64GB 物理空间

### 3.5 跳过共享目录

点击 **"继续"**（不需要配置共享目录）

### 3.6 命名并保存

1. 虚拟机名称：`Home Assistant`
2. 点击 **"保存"**

### 3.7 导入 Home Assistant OS 镜像

1. 在 UTM 中选择刚创建的 "Home Assistant" 虚拟机
2. 点击右侧的 **"编辑"** 按钮（齿轮图标）
3. 点击左侧的 **"驱动器"**
4. 选中默认的磁盘驱动器，点击 **"删除"**
5. 点击 **"新建驱动器"**
6. 点击 **"导入"**
7. 选择之前下载的 `haos_ova-XX.X.aarch64.qcow2` 文件
8. 等待导入完成
9. 点击 **"保存"**

### 3.8 配置网络（重要）

1. 在编辑界面，点击左侧的 **"网络"**
2. 网络模式保持为 **"共享网络"** (Shared Network)
3. 模拟网卡选择 **"virtio-net-pci"**
4. 点击 **"保存"**

> 💡 提示：共享网络模式最稳定，适合大多数用户

---

## 第四步：首次启动和初始设置

### 4.1 启动虚拟机

1. 在 UTM 中选择 "Home Assistant" 虚拟机
2. 点击 **"播放"** 按钮（▶️）
3. 观察启动过程

### 4.2 等待系统初始化

**首次启动需要 5-10 分钟，请耐心等待！**

启动过程：
1. ⏱️ 系统启动（1-2 分钟）
2. ⏱️ Home Assistant OS 初始化（2-3 分钟）
3. ⏱️ Home Assistant Core 安装（3-5 分钟）
4. ⏱️ 集成加载（1-2 分钟）

**启动完成标志：**
控制台显示：
```
Welcome to Home Assistant
homeassistant login:
```

### 4.3 访问 Web 界面

打开浏览器，访问：

```
http://homeassistant.local:8123
```

如果无法访问，尝试：
1. 等待更长时间（可能需要 15 分钟）
2. 刷新浏览器页面
3. 查看虚拟机控制台获取 IP 地址，使用 `http://IP地址:8123` 访问

### 4.4 完成初始设置向导

1. **创建账户**
   - 输入姓名
   - 输入用户名
   - 设置密码（至少 8 位）
   - 点击 "创建账户"

2. **设置位置**
   - 允许检测位置，或手动输入
   - 设置时区
   - 点击 "下一步"

3. **分享数据**（可选）
   - 选择是否分享匿名使用数据
   - 点击 "下一步"

4. **完成设置**
   - 点击 "完成"

恭喜！你已经成功安装了 Home Assistant！

---

## 第五步：扩展磁盘空间（可选但推荐）

如果你在创建虚拟机时设置了 64GB，可以跳过此步骤。

### 为什么需要扩展？

- 安装插件需要空间
- 存储历史数据
- 安装多个集成
- 避免"磁盘空间不足"错误

### 扩展步骤

#### 5.1 关闭虚拟机

在 Home Assistant 界面：
- **设置** → **系统** → **关机**

或在 UTM 中点击 **"停止"** 按钮

#### 5.2 扩展磁盘

1. 在 UTM 中选择虚拟机
2. 点击 **"编辑"**
3. 点击 **"驱动器"**
4. 选择主磁盘
5. 将 **"大小"** 改为 **64000 MB** (64 GB)
6. 点击 **"保存"**

#### 5.3 重新启动

点击 **"播放"** 按钮启动虚拟机

Home Assistant OS 会自动扩展文件系统，无需手动操作。

#### 5.4 验证空间

启动后，在 Home Assistant 中：
- **设置** → **系统** → **存储**
- 查看可用空间应该接近 60GB

---

## 第六步：安装 HACS 社区商店

HACS (Home Assistant Community Store) 是社区商店，可以安装数千个社区开发的集成和主题。

### 为什么需要 HACS？

- ✅ 安装米家设备集成
- ✅ 访问社区开发的集成
- ✅ 安装美化主题
- ✅ 自动更新管理

### 6.1 安装 Terminal & SSH 插件

1. 在 Home Assistant 界面，点击 **"设置"**
2. 点击 **"加载项"**
3. 点击右下角 **"加载项商店"**
4. 搜索 **"Terminal & SSH"**
5. 点击 **"Terminal & SSH"**
6. 点击 **"安装"**（等待 2-3 分钟）
7. 安装完成后，点击 **"启动"**
8. 勾选 **"在侧边栏显示"**

### 6.2 在 Terminal 中安装 HACS

1. 点击左侧菜单的 **"Terminal"**
2. 在终端中输入以下命令：

```bash
wget -O - https://get.hacs.xyz | bash -
```

3. 等待安装完成，看到以下信息表示成功：
```
INFO: HACS installation complete!
```

### 6.3 重启 Home Assistant

在 Terminal 中执行：

```bash
ha core restart
```

或在界面中：**设置** → **系统** → **重启**

等待 1-2 分钟让系统重启。

### 6.4 配置 HACS

1. 重启完成后，进入 **设置** → **设备与服务**
2. 点击右下角 **"+ 添加集成"**
3. 搜索 **"HACS"**
4. 点击 **"HACS"**

#### 6.4.1 同意条款

- 勾选所有复选框
- 点击 **"提交"**

#### 6.4.2 GitHub 授权

1. 会显示一个设备代码（例如：`ABCD-1234`）
2. 点击链接跳转到 GitHub 授权页面
3. 如果没有 GitHub 账号，先注册一个（免费）
4. 登录 GitHub
5. 输入设备代码
6. 点击 **"继续"**
7. 点击 **"授权 hacs"**

#### 6.4.3 完成配置

1. 返回 Home Assistant 页面
2. 等待 HACS 初始化（1-2 分钟）
3. 配置完成后，左侧菜单会出现 **"HACS"** 选项

### 6.5 验证安装

点击左侧的 **"HACS"**，应该能看到 HACS 界面。

---

## 第七步：集成米家设备（可选）

如果你有小米米家智能设备，可以通过 HACS 安装 Xiaomi Home 集成。

### 7.1 通过 HACS 安装 Xiaomi Home

1. 点击左侧菜单的 **"HACS"**
2. 点击 **"集成"**
3. 点击右下角 **"+ 浏览并下载存储库"**
4. 搜索 **"Xiaomi Miot Auto"**
5. 点击 **"Xiaomi Miot Auto"**
6. 点击 **"下载"**
7. 选择最新版本
8. 点击 **"下载"**

### 7.2 重启 Home Assistant

**设置** → **系统** → **重启**

等待 1-2 分钟。

### 7.3 配置 Xiaomi Home 集成

1. **设置** → **设备与服务**
2. 点击 **"+ 添加集成"**
3. 搜索 **"Xiaomi Miot Auto"**
4. 点击选择

#### 7.3.1 选择登录方式

**推荐：扫码登录**
1. 选择 "扫码登录"
2. 使用米家 App 扫描二维码
3. 在手机上确认授权

**或：账号密码登录**
1. 输入小米账号（手机号或邮箱）
2. 输入密码
3. 选择服务器区域：
   - 中国大陆：选择 **"中国"** 或 **"cn"**
   - 其他地区：选择对应区域

#### 7.3.2 等待设备发现

- 系统会自动发现米家设备
- 可能需要 1-3 分钟
- 发现后会显示设备列表

#### 7.3.3 选择设备

- 勾选要添加的设备
- 点击 **"提交"**

设备将被添加到 Home Assistant！

### 7.4 验证设备

1. 进入 **设置** → **设备与服务**
2. 找到 **"Xiaomi Miot Auto"**
3. 点击查看已添加的设备
4. 尝试控制设备

---

## 常见问题解决

### ❓ 虚拟机无法启动

**可能原因：**
- 镜像文件损坏
- UEFI 启动未启用
- 内存分配不足

**解决方案：**
1. 重新下载镜像文件
2. 检查虚拟机设置中的 UEFI 启动
3. 增加内存分配到至少 2GB

### ❓ 无法访问 Web 界面

**可能原因：**
- 系统还在初始化
- 网络配置问题
- 防火墙阻止

**解决方案：**
1. 等待更长时间（首次启动可能需要 15 分钟）
2. 检查虚拟机网络模式是否为"共享网络"
3. 尝试使用 IP 地址访问
4. 检查 macOS 防火墙设置

### ❓ 磁盘空间不足

**症状：**
- 安装插件时提示空间不足
- 无法更新系统

**解决方案：**
参考 [第五步：扩展磁盘空间](#第五步扩展磁盘空间可选但推荐)

### ❓ HACS 安装失败

**可能原因：**
- 网络连接问题
- Terminal 插件未正确安装

**解决方案：**
1. 检查网络连接
2. 重启 Terminal 插件
3. 重新执行安装命令
4. 查看错误信息

### ❓ 米家设备登录失败

**最常见原因：服务器区域选择错误**

**解决方案：**
1. 中国大陆用户必须选择 **"cn"** 或 **"中国"**
2. 使用扫码登录避免密码问题
3. 确保在米家 App 中设置了密码
4. 先在米家 App 中完成所有验证

### ❓ 网络连接问题

**症状：**
- 无法下载更新
- 无法访问外网

**解决方案：**
1. 检查 Mac 的网络连接
2. 重启虚拟机
3. 检查 UTM 网络设置
4. 尝试切换网络模式

---

## 🎉 完成！

恭喜你完成了 Home Assistant 的完整安装！

### 下一步可以做什么？

1. **探索界面**
   - 熟悉 Home Assistant 的各个功能
   - 查看仪表板和设置

2. **添加更多设备**
   - 通过 HACS 安装更多集成
   - 连接其他智能设备

3. **创建自动化**
   - 设置场景和自动化规则
   - 让设备智能联动

4. **美化界面**
   - 通过 HACS 安装主题
   - 自定义仪表板

5. **配置 HomeKit**
   - 将设备桥接到 Apple 家庭
   - 使用 Siri 控制设备

### 推荐资源

- [Home Assistant 官方文档](https://www.home-assistant.io/docs/)
- [Home Assistant 中文社区](https://bbs.hassbian.com/)
- [HACS 官方文档](https://hacs.xyz/)
- [UTM 官方文档](https://docs.getutm.app/)

### 定期维护

- ✅ 每月检查并安装更新
- ✅ 定期创建备份
- ✅ 清理不需要的日志和备份
- ✅ 监控磁盘空间使用

---

## 📝 文档信息

- **版本**：1.0
- **创建日期**：2024-12-09
- **适用系统**：macOS (Apple Silicon)
- **Home Assistant 版本**：2024.12+
- **作者**：根据实际安装经验整理

---

## 💬 需要帮助？

如果遇到问题：

1. 查看本文档的 [常见问题解决](#常见问题解决) 部分
2. 查看 Home Assistant 日志：**设置** → **系统** → **日志**
3. 访问 Home Assistant 中文社区寻求帮助
4. 查看 GitHub Issues

---

**祝你使用愉快！🏠✨**
